<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CRISTINA INFINITO</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{overflow:hidden;position:fixed;width:100%;height:100%;touch-action:manipulation;background:#0a0008;font-family:Arial,sans-serif}
body{display:flex;align-items:center;justify-content:center}
#GC{position:relative;display:flex;flex-direction:column;align-items:center}
canvas{border:4px solid #FF4500;border-radius:12px;box-shadow:0 0 40px rgba(255,69,0,0.4);touch-action:none}
.ov{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);border-radius:10px;padding:15px;text-align:center;z-index:100;overflow-y:auto}
.ov h1{font-family:'Bangers',cursive;color:#FFD700;font-size:2rem;text-shadow:3px 3px 0 #e94560;margin-bottom:8px}
.ov h2{font-family:'Bangers',cursive;color:#75AADB;font-size:1.2rem;margin-bottom:10px}
.ov p{color:#fff;font-size:.85rem;margin-bottom:5px}
.bt{padding:14px 40px;font-family:'Bangers',cursive;font-size:1.4rem;background:linear-gradient(180deg,#FF4500,#DC143C);color:#fff;border:4px solid #8B0000;border-radius:50px;cursor:pointer;margin-top:12px;text-shadow:2px 2px 0 #000;box-shadow:0 4px 15px rgba(255,69,0,.5)}
.bt:active{transform:translateY(3px);box-shadow:none}
.bt2{background:linear-gradient(180deg,#666,#444);border-color:#333}
.hd{display:none!important}
.wg{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;max-width:340px;margin:10px 0}
.wb{cursor:pointer;padding:8px 14px;border-radius:10px;background:rgba(255,255,255,.08);border:2px solid transparent;text-align:center}
.wb.sel{border-color:#FFD700;background:rgba(255,215,0,.2)}
.cb{width:55px;height:55px;font-size:1.8rem;background:rgba(255,255,255,.8);border:3px solid #333;border-radius:12px;cursor:pointer;pointer-events:auto;display:flex;align-items:center;justify-content:center}
.cs{width:50px;height:50px;font-size:1.1rem;background:rgba(255,100,100,.9);border:3px solid #8B0000;border-radius:12px;cursor:pointer;pointer-events:auto;display:flex;align-items:center;justify-content:center}
@keyframes pu{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
</style>
</head>
<body>
<div id="GC">
<canvas id="cv"></canvas>

<!-- START -->
<div id="SS" class="ov">
<h1 style="font-size:2.2rem">üî• CRISTINA INFINITO üî•</h1>
<h2 style="color:#FF6347">¬°Lleg√° a la Casa Rosada!</h2>
<p style="color:#aaa">Avanz√°, salt√° plataformas y sub√≠ hasta la cima</p>
<p style="color:#aaa">Esquiv√° villanos, gorilas y lleg√° al balc√≥n</p>
<h3 style="color:#FFD700;font-family:Bangers;font-size:1.1rem;margin:15px 0 8px">üéØ Eleg√≠ tu arma:</h3>
<div class="wg">
<div class="wb sel" onclick="selW('choripan')" id="wc"><span style="font-size:1.5rem">ü•ñ</span><p style="font-size:.7rem;margin:2px 0 0">Chorip√°n</p></div>
<div class="wb" onclick="selW('piedra')" id="wp"><span style="font-size:1.5rem">ü™®</span><p style="font-size:.7rem;margin:2px 0 0">Piedra</p></div>
<div class="wb" onclick="selW('empanada')" id="we"><span style="font-size:1.5rem">ü•ü</span><p style="font-size:.7rem;margin:2px 0 0">Empanada</p></div>
<div class="wb" onclick="selW('fernet')" id="wf"><span style="font-size:1.5rem">üçæ</span><p style="font-size:.7rem;margin:2px 0 0">Fernet</p></div>
<div class="wb" onclick="selW('constitucion')" id="wn"><span style="font-size:1.5rem">üìï</span><p style="font-size:.7rem;margin:2px 0 0">Constituci√≥n</p></div>
</div>
<button class="bt" onclick="startGame()" style="animation:pu 1.5s infinite">üî• ¬°JUGAR! üî•</button>
<p style="color:#666;font-size:.65rem;margin-top:8px">‚Üê ‚Üí Mover | ESPACIO Saltar | S Escudo | Z X Disparar</p>
</div>

<!-- GAME OVER -->
<div id="GO" class="ov hd">
<h1>üíÄ ¬°TE ATRAPARON! üíÄ</h1>
<p id="goT" style="color:#FF6347;font-size:1.1rem"></p>
<p id="goS" style="font-family:Bangers;color:#FFD700;font-size:2rem;margin:10px 0"></p>
<p id="goH" style="color:#aaa"></p>
<p id="goR" style="color:#75AADB"></p>
<button class="bt" onclick="startGame()">üî• REINTENTAR üî•</button>
<button class="bt bt2" onclick="showStart()">üè† MEN√ö</button>
</div>

<!-- VICTORY -->
<div id="VI" class="ov hd">
<h1 style="font-size:1.8rem">üèõÔ∏è ¬°LLEGASTE A LA CASA ROSADA! üèõÔ∏è</h1>
<h2>‚õìÔ∏èüí• ¬°CRISTINA LIBRE! üí•‚õìÔ∏è</h2>
<p style="color:#FFD700;font-size:1.1rem">¬°El pueblo te aclama desde el balc√≥n!</p>
<p id="viS" style="font-family:Bangers;color:#FFD700;font-size:2rem;margin:10px 0"></p>
<p id="viT" style="color:#75AADB"></p>
<button class="bt" onclick="startGame()">üî• JUGAR DE NUEVO üî•</button>
<button class="bt bt2" onclick="showStart()">üè† MEN√ö</button>
</div>

<!-- MOBILE -->
<div id="MC" class="hd" style="position:absolute;bottom:5px;left:0;right:0;z-index:500;pointer-events:none">
<div style="display:flex;justify-content:center;gap:8px;margin-bottom:6px;pointer-events:auto">
<button class="cs" id="bSL">‚¨Öüî¥</button>
<button class="cs" id="bSU">‚¨Üüî¥</button>
<button class="cs" id="bSR">üî¥‚û°</button>
</div>
<div style="display:flex;justify-content:space-between;padding:0 10px">
<div style="display:flex;gap:8px;pointer-events:auto">
<button class="cb" id="bL">‚¨ÖÔ∏è</button>
<button class="cb" id="bR">‚û°Ô∏è</button>
</div>
<div style="display:flex;gap:8px;pointer-events:auto">
<button class="cb" id="bJ" style="background:rgba(100,255,100,.8);border-color:#228B22">‚¨ÜÔ∏è</button>
<button class="cb" id="bSh" style="background:rgba(117,170,219,.8);border-color:#4169E1">üõ°Ô∏è</button>
</div>
</div>
</div>
</div>
<script>
// =============================================
// CRISTINA INFINITO - Scroll Horizontal + Subida
// =============================================
const cv=document.getElementById('cv'), cx=cv.getContext('2d');
const isM=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
function resize(){cv.width=Math.min(innerWidth-16,420);cv.height=Math.min(innerHeight-16,700);}
resize(); addEventListener('resize',resize);
function $(id){return document.getElementById(id);}

// --- SPRITES ---
const sp={};
const SPN=['milei','majul','feinmann','lanata','gordo_dan','viale','trebuc','cristina','bullrich','macri','trump','karina','caputo','adorni','policia','potobellocchia','motosierra','sturzenegger','espert2','gorila','escudo','cfk','balcon'];
SPN.forEach(n=>{const i=new Image();i.src='./sprites/'+n+'.png';i.onload=()=>{sp[n]=i};});

// --- AUDIO ---
let actx=null, aOn=true, mus=null;
function iA(){if(!actx)actx=new(AudioContext||webkitAudioContext)();if(actx.state==='suspended')actx.resume();}
document.addEventListener('touchstart',()=>{iA();if(mus&&mus.paused&&gRun)mus.play().catch(()=>{});},{passive:true});
document.addEventListener('click',()=>{iA();if(mus&&mus.paused&&gRun)mus.play().catch(()=>{});},{passive:true});
function playMus(){if(mus){mus.pause();}mus=new Audio('./marchaperonistainfinito.mp3');mus.loop=true;mus.volume=.25;mus.play().catch(()=>{});}
function stopMus(){if(mus){mus.pause();mus=null;}}
function snd(t){
if(!aOn||!actx)return;try{
const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);const c=actx.currentTime;
if(t==='jump'){o.type='sine';o.frequency.setValueAtTime(400,c);o.frequency.exponentialRampToValueAtTime(800,c+.15);g.gain.setValueAtTime(.15,c);g.gain.exponentialRampToValueAtTime(.01,c+.15);o.start();o.stop(c+.15);}
else if(t==='shoot'){o.type='triangle';o.frequency.setValueAtTime(600,c);o.frequency.exponentialRampToValueAtTime(200,c+.12);g.gain.setValueAtTime(.2,c);g.gain.exponentialRampToValueAtTime(.01,c+.12);o.start();o.stop(c+.12);}
else if(t==='hit'){o.type='sawtooth';o.frequency.setValueAtTime(200,c);o.frequency.exponentialRampToValueAtTime(50,c+.15);g.gain.setValueAtTime(.3,c);g.gain.exponentialRampToValueAtTime(.01,c+.15);o.start();o.stop(c+.15);}
else if(t==='kill'){o.type='sine';o.frequency.setValueAtTime(800,c);o.frequency.exponentialRampToValueAtTime(1200,c+.1);g.gain.setValueAtTime(.2,c);g.gain.exponentialRampToValueAtTime(.01,c+.15);o.start();o.stop(c+.15);}
else if(t==='shield'){o.type='sine';o.frequency.setValueAtTime(1000,c);o.frequency.setValueAtTime(1200,c+.05);g.gain.setValueAtTime(.15,c);g.gain.exponentialRampToValueAtTime(.01,c+.1);o.start();o.stop(c+.1);}
else if(t==='go'){o.type='sine';o.frequency.setValueAtTime(400,c);o.frequency.setValueAtTime(200,c+.4);g.gain.setValueAtTime(.3,c);g.gain.exponentialRampToValueAtTime(.01,c+.6);o.start();o.stop(c+.6);}
else if(t==='vic'){o.type='sine';o.frequency.setValueAtTime(523,c);o.frequency.setValueAtTime(659,c+.15);o.frequency.setValueAtTime(784,c+.3);o.frequency.setValueAtTime(1047,c+.45);g.gain.setValueAtTime(.3,c);g.gain.exponentialRampToValueAtTime(.01,c+.6);o.start();o.stop(c+.6);}
}catch(e){}}

const eAud={};
['majul','majul2','majul3','feinmann','feinmann1','feinmann2','lanata','lanata1','lanata2','milei1','milei2','karina','karina1','karina2','bullrich','caputo','adorni','adorni1','policia','sturzenegger','trump','macri','potobellocchia (1)','gordo_dan','viale','trebuc','trebuc1','trebuc2','espert'].forEach(n=>{const a=new Audio();a.src='./audios/'+n+'.mp3';a.volume=.4;eAud[n]=a;});
function playEA(e){
if(!aOn)return;let n;
if(e.tp===1){const p=['majul','feinmann','gordo_dan','viale','trebuc','lanata'];let b=p[e.pi||0];if(b==='majul')n=['majul','majul2','majul3'][~~(Math.random()*3)];else if(b==='feinmann')n=['feinmann','feinmann1','feinmann2'][~~(Math.random()*3)];else if(b==='lanata')n=['lanata','lanata1','lanata2'][~~(Math.random()*3)];else if(b==='trebuc')n=['trebuc','trebuc1','trebuc2'][~~(Math.random()*3)];else n=b;}
else if(e.tp===0)n=['milei1','milei2'][~~(Math.random()*2)];
else if(e.tp===2)n=['karina','karina1','karina2'][~~(Math.random()*3)];
else if(e.tp===6)n=['adorni','adorni1'][~~(Math.random()*2)];
else{const m={3:'bullrich',4:'caputo',5:'policia',7:'sturzenegger',9:'macri',11:'potobellocchia (1)',13:'trump',14:'espert'};n=m[e.tp];}
if(n&&eAud[n])try{eAud[n].currentTime=0;eAud[n].play().catch(()=>{});}catch(x){}
}

// =============================================
// GAME STATE
// =============================================
let gRun=false, wep='choripan', hiSc=0;

// Player (world coords)
let P={x:100, y:0, vx:0, vy:0, w:40, h:50, og:false, jp:false, sa:false, se:100, fr:true};

// Camera (world coords of top-left of viewport)
let cam={x:0, y:0};

// Physics
const GV=0.6, JF=-13, SPD=4.5, BF=-10;

// World data
let platforms=[], enemies=[], proj=[], eProj=[], parts=[];
let sc=0, vid=5, wav=1;
let tRem=300, tStart=0, won=false;
let mL=false, mR=false, skH=false, lsd=1, lOff=0;
let worldGenX=0; // how far right we've generated
let worldGenY=0; // base Y for generation (goes up over distance)

// Total world distance to Casa Rosada
const GOAL_DIST = 20000;

function selW(w){wep=w;document.querySelectorAll('.wb').forEach(b=>b.classList.remove('sel'));const ids={choripan:'wc',piedra:'wp',empanada:'we',fernet:'wf',constitucion:'wn'};$(ids[w]).classList.add('sel');}
function showStart(){gRun=false;stopMus();$('SS').classList.remove('hd');$('GO').classList.add('hd');$('VI').classList.add('hd');$('MC').classList.add('hd');}
function fmT(s){return ~~(s/60)+':'+(s%60<10?'0':'')+(s%60);}

// =============================================
// WORLD GENERATION
// =============================================
function generateWorld(upToX) {
    // Generate platforms and enemies from worldGenX to upToX
    while (worldGenX < upToX) {
        // Base ground elevation drops (goes up) as we progress
        // Every 400px horizontal = ~30px higher
        let baseY = cv.height - 100 - (worldGenX / GOAL_DIST) * (cv.height * 0.8);

        // Ground segment (mostly present, small gaps occasionally)
        let hasGround = Math.random() > 0.08 || worldGenX < 600;
        if (hasGround) {
            let gw = 120 + Math.random() * 200;
            platforms.push({
                x: worldGenX, y: baseY, w: gw, h: 18,
                tp: 'ground', mv: null
            });
        }

        // Floating platforms (some moving)
        let numPlats = 1 + ~~(Math.random() * 3);
        for (let i = 0; i < numPlats; i++) {
            let px = worldGenX + Math.random() * 180;
            let py = baseY - 50 - Math.random() * 120;
            let pw = 55 + Math.random() * 70;
            let isLava = Math.random() > 0.9;
            let mvType = null;

            // 40% chance of moving platform
            if (Math.random() > 0.6) {
                if (Math.random() > 0.5) {
                    // Horizontal movement
                    mvType = {axis:'x', range: 40 + Math.random()*60, speed: 0.5 + Math.random()*1.5, phase: Math.random()*Math.PI*2};
                } else {
                    // Vertical movement
                    mvType = {axis:'y', range: 30 + Math.random()*50, speed: 0.4 + Math.random()*1.2, phase: Math.random()*Math.PI*2};
                }
            }

            platforms.push({
                x: px, y: py, w: pw, h: 14,
                tp: isLava ? 'lava' : 'float',
                mv: mvType, ox: px, oy: py
            });

            // Spawn enemy on platform (40% chance, more as we progress)
            let enemyChance = 0.3 + (worldGenX / GOAL_DIST) * 0.3;
            if (Math.random() < enemyChance && enemies.length < 20) {
                spawnEnemy(px + 10, py - 50);
            }
        }

        worldGenX += 150 + Math.random() * 100;
    }
}

function spawnEnemy(ex, ey) {
    const allTypes = [0,1,2,3,4,5,6,7,9,11,13,14,15]; // 15 = gorila
    // Gorilas more common as we progress
    let tp;
    if (Math.random() < 0.15 + (worldGenX / GOAL_DIST) * 0.25) {
        tp = 15; // gorila
    } else {
        tp = allTypes[~~(Math.random() * (allTypes.length - 1))]; // exclude gorila from random
    }

    let e = {
        x: ex, y: ey, w: 35, h: 45,
        vx: (Math.random() > 0.5 ? 1 : -1) * (0.5 + wav * 0.05),
        tp: tp,
        hp: tp === 15 ? 2 + ~~(wav/3) : 1 + ~~(wav/5),
        ls: 0, startX: ex,
        patrol: 50 + Math.random() * 60
    };
    if (tp === 1) e.pi = ~~(Math.random() * 6);
    enemies.push(e);
}

// =============================================
// START GAME
// =============================================
function startGame() {
    iA(); gRun = true;
    sc = 0; vid = 5; wav = 1; won = false;
    tRem = 300; tStart = Date.now();
    worldGenX = 0;

    P.x = 100; P.y = cv.height - 200;
    P.vx = 0; P.vy = 0; P.og = false; P.jp = false;
    P.sa = false; P.se = 100; P.fr = true;

    cam.x = 0; cam.y = 0;
    platforms = []; enemies = []; proj = []; eProj = []; parts = [];
    lOff = 0;

    // Generate initial world
    generateWorld(cv.width + 400);

    // Starting ground
    platforms.unshift({x: 0, y: cv.height - 100, w: 300, h: 20, tp: 'ground', mv: null});

    playMus();
    $('SS').classList.add('hd'); $('GO').classList.add('hd'); $('VI').classList.add('hd');
    if (isM) $('MC').classList.remove('hd');
    requestAnimationFrame(loop);
}

// =============================================
// SHOOT / JUMP / DAMAGE
// =============================================
function shootDir(dx, dy) {
    const px = P.x + P.w/2, py = P.y + P.h/2;
    const d = Math.sqrt(dx*dx + dy*dy) || 1;
    proj.push({x:px, y:py, vx:(dx/d)*14, vy:(dy/d)*14-2, tp:wep, a:0});
    if (dx !== 0) lsd = dx > 0 ? 1 : -1;
    snd('shoot');
}
function shootSide(d) { shootDir(d * 10, -2); }
function shootUp() { shootDir(lsd * 2, -12); }
function jump() {
    if (P.og && !P.jp) { P.vy = JF; P.jp = true; P.og = false; snd('jump'); }
}
function takeDmg() {
    vid--; snd('hit');
    spawnParts(P.x + P.w/2, P.y + P.h/2, '#FF0000', 8);
    if (vid <= 0) doGO('¬°Sin vidas!');
}
function spawnParts(x, y, col, n) {
    for (let i = 0; i < n; i++) parts.push({x, y, vx:(Math.random()-.5)*8, vy:-Math.random()*5-2, life:20+Math.random()*15, col, sz:2+Math.random()*4});
}
function doGO(txt) {
    gRun = false; stopMus(); snd('go');
    if (sc > hiSc) hiSc = sc;
    $('goT').textContent = txt;
    $('goS').textContent = 'üèÜ ' + sc;
    $('goH').textContent = 'üìè Distancia: ' + ~~(P.x) + 'm';
    $('goR').textContent = '‚≠ê R√©cord: ' + hiSc;
    $('GO').classList.remove('hd'); $('MC').classList.add('hd');
}
function doWin() {
    gRun = false; won = true; stopMus(); snd('vic');
    if (sc > hiSc) hiSc = sc;
    $('viS').textContent = 'üèÜ ' + sc;
    $('viT').textContent = '‚è±Ô∏è Tiempo restante: ' + fmT(tRem);
    $('VI').classList.remove('hd'); $('MC').classList.add('hd');
}

// =============================================
// UPDATE
// =============================================
function update() {
    if (!gRun) return;

    // Timer
    tRem = Math.max(0, 300 - ~~((Date.now() - tStart) / 1000));
    if (tRem <= 0 && !won) { doGO('¬°Se acab√≥ el tiempo!'); return; }

    // Movement
    if (mL) { P.vx = -SPD; P.fr = false; }
    else if (mR) { P.vx = SPD; P.fr = true; }
    else P.vx *= 0.85;

    // Gravity
    P.vy += GV;
    P.x += P.vx;
    P.y += P.vy;

    // Don't go left of start
    if (P.x < 0) P.x = 0;

    // Update moving platforms
    const now = Date.now() / 1000;
    for (let p of platforms) {
        if (p.mv) {
            if (p.mv.axis === 'x') {
                p.x = p.ox + Math.sin(now * p.mv.speed + p.mv.phase) * p.mv.range;
            } else {
                p.y = p.oy + Math.sin(now * p.mv.speed + p.mv.phase) * p.mv.range;
            }
        }
    }

    // Platform collision (only falling down)
    P.og = false;
    for (let p of platforms) {
        if (P.vy >= 0 &&
            P.x + P.w > p.x && P.x < p.x + p.w &&
            P.y + P.h >= p.y && P.y + P.h <= p.y + p.h + 12) {
            if (p.tp === 'lava') {
                takeDmg(); P.vy = -8;
                if (!gRun) return;
                continue;
            }
            P.y = p.y - P.h;
            P.vy = 0;
            P.og = true;
            P.jp = false;
            // Move with platform
            if (p.mv && p.mv.axis === 'x') {
                P.x += Math.cos(now * p.mv.speed + p.mv.phase) * p.mv.speed * p.mv.range * 0.016;
            }
        }
    }

    // Fall into abyss
    if (P.y > cam.y + cv.height + 100) {
        takeDmg();
        if (!gRun) return;
        // Respawn on nearest platform above
        let best = null, bestDist = Infinity;
        for (let p of platforms) {
            let dx = p.x + p.w/2 - P.x;
            let dy = p.y - P.y;
            let dist = Math.abs(dx) + Math.abs(dy);
            if (dist < bestDist && p.y < P.y) { bestDist = dist; best = p; }
        }
        if (best) { P.x = best.x + best.w/2 - P.w/2; P.y = best.y - P.h - 10; }
        else { P.x = cam.x + 50; P.y = cam.y + 100; }
        P.vy = 0;
    }

    // Enemy movement & collision
    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        e.x += e.vx;
        // Patrol bounds
        if (e.x < e.startX - e.patrol || e.x > e.startX + e.patrol) e.vx *= -1;

        // Enemy shoots occasionally
        if (Date.now() - e.ls > 2500 + Math.random() * 2000 && Math.random() > 0.97) {
            e.ls = Date.now();
            let dx = P.x - e.x, dy = P.y - e.y;
            let dd = Math.sqrt(dx*dx+dy*dy) || 1;
            if (dd < 400) { // only shoot if player nearby
                eProj.push({x: e.x + e.w/2, y: e.y + e.h/2, vx: (dx/dd)*4, vy: (dy/dd)*4, tp: e.tp === 0 ? 'moto' : 'bala', a:0});
            }
        }

        // Player vs enemy
        if (P.x + P.w > e.x && P.x < e.x + e.w && P.y + P.h > e.y && P.y < e.y + e.h) {
            if (P.vy > 0 && P.y + P.h < e.y + e.h/2) {
                // Stomp
                enemies.splice(i, 1);
                P.vy = BF;
                sc += 100;
                snd('kill'); playEA(e);
                spawnParts(e.x + e.w/2, e.y, '#FFD700', 10);
            } else if (!P.sa) {
                takeDmg();
                if (!gRun) return;
                P.vy = -8;
                P.x += (P.x < e.x) ? -40 : 40;
            } else {
                // Shield absorbs
                P.se -= 15;
                snd('shield');
                spawnParts(e.x + e.w/2, e.y, '#75AADB', 5);
                if (P.se <= 0) { P.se = 0; P.sa = false; }
            }
        }
    }

    // Enemy projectiles
    for (let i = eProj.length - 1; i >= 0; i--) {
        let p = eProj[i];
        p.x += p.vx; p.y += p.vy;
        if (p.tp === 'moto') p.a += 0.3;
        // Off screen
        if (Math.abs(p.x - cam.x) > cv.width + 100 || Math.abs(p.y - cam.y) > cv.height + 100) {
            eProj.splice(i, 1); continue;
        }
        // Hit player
        if (p.x > P.x && p.x < P.x + P.w && p.y > P.y && p.y < P.y + P.h) {
            if (P.sa && P.se > 0) {
                eProj.splice(i, 1); P.se -= 20; snd('shield');
                spawnParts(p.x, p.y, '#75AADB', 5);
            } else {
                eProj.splice(i, 1); takeDmg();
                if (!gRun) return;
            }
        }
    }

    // Player projectiles
    for (let i = proj.length - 1; i >= 0; i--) {
        let s = proj[i];
        s.x += s.vx; s.y += s.vy; s.vy += 0.25;
        if (s.a !== undefined) s.a += 0.15;
        if (Math.abs(s.x - cam.x) > cv.width + 100 || Math.abs(s.y - cam.y) > cv.height + 100) {
            proj.splice(i, 1); continue;
        }
        for (let j = enemies.length - 1; j >= 0; j--) {
            let e = enemies[j];
            if (s.x > e.x && s.x < e.x + e.w && s.y > e.y && s.y < e.y + e.h) {
                e.hp--;
                proj.splice(i, 1);
                if (e.hp <= 0) {
                    enemies.splice(j, 1); sc += 50;
                    snd('kill'); playEA(e);
                    spawnParts(e.x + e.w/2, e.y, '#FF4500', 8);
                }
                break;
            }
        }
    }

    // Shield
    if (!P.sa && P.se < 100) P.se = Math.min(P.se + 0.3, 100);
    if (P.sa) { P.se -= 0.5; if (P.se <= 0) { P.se = 0; P.sa = false; } }

    // Score from distance
    sc = Math.max(sc, ~~(P.x / 5));

    // Wave based on distance
    wav = 1 + ~~(P.x / 2000);

    // Camera follows player
    cam.x = P.x - cv.width * 0.35;
    cam.y = P.y - cv.height * 0.55;
    if (cam.x < 0) cam.x = 0;

    // Generate more world ahead
    if (P.x + cv.width + 400 > worldGenX) {
        generateWorld(P.x + cv.width + 800);
    }

    // Cleanup off-screen left
    platforms = platforms.filter(p => p.x + p.w > cam.x - 200);
    enemies = enemies.filter(e => e.x + e.w > cam.x - 200);

    // Check victory
    if (P.x >= GOAL_DIST && !won) { doWin(); return; }

    // Particles
    for (let i = parts.length - 1; i >= 0; i--) {
        let p = parts[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life--;
        if (p.life <= 0) parts.splice(i, 1);
    }
    lOff += 0.5;
}

// =============================================
// DRAW
// =============================================
function draw() {
    const W = cv.width, H = cv.height;

    // Progress ratio (0 to 1)
    let prog = Math.min(P.x / GOAL_DIST, 1);

    // Background: hell gradient that shifts as you progress
    let grd = cx.createLinearGradient(0, 0, 0, H);
    // Start: dark red hell -> End: pinkish dawn near Casa Rosada
    let r1 = ~~(26 + prog * 40), g1 = ~~(0 + prog * 20), b1 = ~~(8 + prog * 30);
    let r2 = ~~(107 - prog * 50), g2 = ~~(0 + prog * 40), b2 = ~~(0 + prog * 60);
    grd.addColorStop(0, `rgb(${r1},${g1},${b1})`);
    grd.addColorStop(0.5, `rgb(${~~(45+prog*30)},${~~(prog*20)},${~~(20+prog*30)})`);
    grd.addColorStop(1, `rgb(${r2},${g2},${b2})`);
    cx.fillStyle = grd;
    cx.fillRect(0, 0, W, H);

    // Background fire/lava particles
    for (let i = 0; i < 15; i++) {
        let fx = ((i * 97 + lOff * 1.5) % (W + 80)) - 40;
        let fy = H - 20 + Math.sin(lOff * 0.04 + i) * 30;
        let sz = 2 + Math.sin(lOff * 0.08 + i * 2) * 2;
        cx.fillStyle = `rgba(255,${60+~~(Math.sin(lOff*.06+i)*50)},0,${.2+Math.sin(lOff*.05+i)*.15})`;
        cx.beginPath(); cx.arc(fx, fy, sz, 0, Math.PI*2); cx.fill();
    }

    // Distant mountains/volcanoes
    cx.fillStyle = 'rgba(80,0,20,0.3)';
    cx.beginPath(); cx.moveTo(0, H * 0.6);
    for (let x = 0; x <= W; x += 30) {
        let mh = Math.sin((x + cam.x * 0.1) * 0.008) * 60 + Math.sin((x + cam.x * 0.1) * 0.02) * 25;
        cx.lineTo(x, H * 0.6 - mh);
    }
    cx.lineTo(W, H); cx.lineTo(0, H); cx.fill();

    cx.save();
    cx.translate(-cam.x, -cam.y);

    // --- PLATFORMS ---
    for (let p of platforms) {
        // Only draw visible
        if (p.x + p.w < cam.x - 10 || p.x > cam.x + W + 10) continue;
        if (p.y + p.h < cam.y - 10 || p.y > cam.y + H + 10) continue;

        if (p.tp === 'lava') {
            cx.fillStyle = '#8B0000';
            cx.fillRect(p.x, p.y, p.w, p.h);
            cx.fillStyle = '#FF4500';
            cx.fillRect(p.x + 2, p.y + 2, p.w - 4, p.h - 4);
            for (let lx = p.x; lx < p.x + p.w; lx += 8) {
                let h = Math.sin((lx + lOff * 3) * 0.15) * 4 + 2;
                cx.fillStyle = 'rgba(255,100,0,.6)';
                cx.fillRect(lx, p.y - h, 6, h);
            }
        } else if (p.tp === 'ground') {
            // Solid ground - dark brick
            cx.fillStyle = '#5C3317';
            cx.fillRect(p.x, p.y, p.w, p.h);
            cx.fillStyle = '#6B3A20';
            for (let bx = p.x; bx < p.x + p.w - 2; bx += 20) {
                cx.fillRect(bx + 1, p.y + 1, 18, p.h - 2);
            }
            cx.fillStyle = '#7B4A30';
            cx.fillRect(p.x, p.y, p.w, 3);
            // Dirt below
            cx.fillStyle = '#3A1A00';
            cx.fillRect(p.x, p.y + p.h, p.w, 40);
        } else {
            // Floating platform - brick
            let isMoving = !!p.mv;
            cx.fillStyle = isMoving ? '#8B6914' : '#8B4513';
            cx.fillRect(p.x, p.y, p.w, p.h);
            cx.fillStyle = isMoving ? '#A07828' : '#A0522D';
            for (let bx = p.x; bx < p.x + p.w - 2; bx += 18) {
                cx.fillRect(bx + 1, p.y + 1, 16, p.h - 2);
            }
            cx.fillStyle = isMoving ? '#C09030' : '#CD853F';
            cx.fillRect(p.x, p.y, p.w, 3);
            // Glow for moving
            if (isMoving) {
                cx.strokeStyle = 'rgba(255,215,0,.3)';
                cx.lineWidth = 1;
                cx.strokeRect(p.x - 1, p.y - 1, p.w + 2, p.h + 2);
            }
        }
    }

    // --- CASA ROSADA (goal) ---
    if (GOAL_DIST - cam.x < W + 300) {
        drawCasaRosada();
    }

    // --- ENEMY PROJECTILES ---
    for (let p of eProj) {
        if (p.tp === 'moto' && sp.motosierra) {
            cx.save(); cx.translate(p.x, p.y); cx.rotate(p.a);
            cx.drawImage(sp.motosierra, -18, -15, 36, 30);
            cx.restore();
        } else {
            cx.fillStyle = '#FF0000';
            cx.beginPath(); cx.arc(p.x, p.y, 5, 0, Math.PI*2); cx.fill();
        }
    }

    // --- ENEMIES ---
    for (let e of enemies) {
        if (e.x + e.w < cam.x - 50 || e.x > cam.x + W + 50) continue;
        if (e.y + e.h < cam.y - 50 || e.y > cam.y + H + 50) continue;
        drawEnemy(e);
    }

    // --- PLAYER PROJECTILES ---
    for (let p of proj) {
        cx.save(); cx.translate(p.x, p.y); cx.rotate(p.a || 0);
        drawProj(p.tp);
        cx.restore();
    }

    // --- PLAYER ---
    drawPlayer();

    // --- PARTICLES ---
    for (let p of parts) {
        cx.globalAlpha = Math.max(0, p.life / 35);
        cx.fillStyle = p.col;
        cx.beginPath(); cx.arc(p.x, p.y, p.sz, 0, Math.PI*2); cx.fill();
    }
    cx.globalAlpha = 1;

    cx.restore();

    // --- HUD ---
    drawHUD(prog);
}

function drawCasaRosada() {
    let cx2 = GOAL_DIST - 100;
    let baseY = cv.height - 100 - (GOAL_DIST / GOAL_DIST) * (cv.height * 0.8);
    let crY = baseY - 180;
    let crW = 250, crH = 200;

    if (sp.balcon) {
        cx.drawImage(sp.balcon, cx2 - 50, crY, crW, crH);
    } else {
        // Fallback Casa Rosada
        cx.fillStyle = '#D4826A';
        cx.fillRect(cx2, crY, crW - 50, crH);
        // Dome
        cx.fillStyle = '#C4756A';
        cx.beginPath();
        cx.ellipse(cx2 + 100, crY, 50, 30, 0, Math.PI, 0);
        cx.fill();
        // Windows
        cx.fillStyle = '#1a1a1a';
        for (let i = 0; i < 4; i++) {
            cx.beginPath();
            cx.arc(cx2 + 25 + i * 45, crY + 60, 12, Math.PI, 0);
            cx.fill();
        }
        // Balc√≥n
        cx.fillStyle = '#FFF';
        cx.fillRect(cx2 + 30, crY + 90, 140, 8);
        // Columns
        for (let i = 0; i < 5; i++) {
            cx.fillStyle = '#E8D8C8';
            cx.fillRect(cx2 + 35 + i * 32, crY + 98, 6, 40);
        }
        // Flag
        cx.fillStyle = '#75AADB';
        cx.fillRect(cx2 + 95, crY - 40, 3, 40);
        cx.fillRect(cx2 + 98, crY - 40, 25, 8);
        cx.fillStyle = '#FFF';
        cx.fillRect(cx2 + 98, crY - 32, 25, 8);
        cx.fillStyle = '#75AADB';
        cx.fillRect(cx2 + 98, crY - 24, 25, 8);
    }

    // Multitud
    let mY = baseY + 10;
    let colors = ['#75AADB','#FFF','#FFD700','#00AA00','#FF6B6B'];
    let t = Date.now();
    for (let row = 0; row < 3; row++) {
        for (let i = 0; i < 10; i++) {
            let mx = cx2 - 30 + i * 28;
            let my = mY + row * 20;
            let bounce = Math.sin(t / 200 + i + row) * 3;
            cx.fillStyle = '#FFDAB9';
            cx.beginPath(); cx.arc(mx, my + bounce, 5, 0, Math.PI*2); cx.fill();
            cx.fillStyle = colors[(i + row) % colors.length];
            cx.fillRect(mx - 4, my + 5 + bounce, 8, 10);
        }
    }
}

function drawPlayer() {
    let img = sp['cfk'] || sp['cristina'];
    let dW = 65, dH = 80;
    let dX = P.x + (P.w/2) - (dW/2);
    let dY = P.y + P.h - dH;

    cx.save();
    if (!P.fr) {
        let cxx = P.x + P.w/2;
        cx.translate(cxx, 0); cx.scale(-1, 1); cx.translate(-cxx, 0);
    }
    if (img) cx.drawImage(img, dX, dY, dW, dH);
    else {
        cx.fillStyle = '#75AADB';
        cx.fillRect(P.x, P.y, P.w, P.h);
        cx.fillStyle = '#FFD700'; cx.font = 'bold 10px Arial'; cx.textAlign = 'center';
        cx.fillText('CFK', P.x + P.w/2, P.y + P.h/2 + 4);
    }
    cx.restore();

    // Shield glow
    if (P.sa && P.se > 0) {
        let sx = P.x + P.w/2, sy = P.y + P.h/2;
        let pulse = Math.sin(Date.now() / 100) * 3;
        if (sp.escudo) {
            cx.globalAlpha = 0.8;
            cx.drawImage(sp.escudo, sx - 34 - pulse/2, sy - 34 - pulse/2, 68 + pulse, 68 + pulse);
            cx.globalAlpha = 1;
        }
        cx.strokeStyle = 'rgba(255,215,0,.5)';
        cx.lineWidth = 3;
        cx.beginPath(); cx.ellipse(sx, sy, 38 + pulse, 42 + pulse, 0, 0, Math.PI*2); cx.stroke();
        cx.fillStyle = 'rgba(117,170,219,.12)';
        cx.beginPath(); cx.ellipse(sx, sy, 36 + pulse, 40 + pulse, 0, 0, Math.PI*2); cx.fill();
    }
}

function drawEnemy(e) {
    let names = {0:'milei',2:'karina',3:'bullrich',4:'caputo',5:'policia',6:'adorni',7:'sturzenegger',9:'macri',11:'potobellocchia',13:'trump',14:'espert2',15:'gorila'};
    let sn = names[e.tp];
    if (e.tp === 1) { sn = ['majul','feinmann','gordo_dan','viale','trebuc','lanata'][e.pi||0]; }
    if (sn && sp[sn]) {
        let img = sp[sn];
        // Fixed draw size, not based on img.width (PNGs can be huge)
        let iw = e.tp === 15 ? 50 : 40;
        let ih = e.tp === 15 ? 60 : 50;
        cx.drawImage(img, e.x + e.w/2 - iw/2, e.y + e.h - ih, iw, ih);
    } else {
        cx.fillStyle = e.tp === 15 ? '#4A6B8A' : '#8B008B';
        cx.fillRect(e.x, e.y, e.w, e.h);
        if (e.tp === 15) {
            // Fallback gorila
            cx.fillStyle = '#FF0000';
            cx.beginPath();
            cx.arc(e.x + 10, e.y + 8, 4, 0, Math.PI*2);
            cx.arc(e.x + 25, e.y + 8, 4, 0, Math.PI*2);
            cx.fill();
        }
    }
    // HP bar if > 1
    if (e.hp > 1) {
        cx.fillStyle = '#333';
        cx.fillRect(e.x, e.y - 6, e.w, 4);
        cx.fillStyle = '#FF0000';
        cx.fillRect(e.x, e.y - 6, e.w * Math.min(e.hp / (1 + ~~(wav/5)), 1), 4);
    }
}

function drawProj(tp) {
    if (tp==='choripan'){cx.fillStyle='#DEB887';cx.beginPath();cx.ellipse(0,0,12,5,0,0,Math.PI*2);cx.fill();cx.fillStyle='#8B4513';cx.beginPath();cx.ellipse(0,-1,10,3,0,0,Math.PI*2);cx.fill();}
    else if(tp==='piedra'){cx.fillStyle='#696969';cx.beginPath();cx.ellipse(0,0,9,7,0,0,Math.PI*2);cx.fill();}
    else if(tp==='empanada'){cx.fillStyle='#DAA520';cx.beginPath();cx.ellipse(0,0,10,7,0,0,Math.PI*2);cx.fill();cx.strokeStyle='#654321';cx.lineWidth=2;cx.beginPath();cx.ellipse(0,0,10,7,0,0,Math.PI);cx.stroke();}
    else if(tp==='fernet'){cx.fillStyle='#1a1a1a';cx.fillRect(-4,-8,8,18);cx.fillStyle='#8B0000';cx.fillRect(-3,-3,6,8);cx.fillStyle='#FFD700';cx.fillRect(-2,-10,4,3);}
    else if(tp==='constitucion'){cx.fillStyle='#8B0000';cx.fillRect(-7,-9,14,18);cx.fillStyle='#FFF8DC';cx.fillRect(-5,-7,10,14);cx.fillStyle='#1a1a1a';cx.font='5px Arial';cx.textAlign='center';cx.fillText('CN',0,2);}
}

function drawHUD(prog) {
    cx.textAlign = 'left';
    // Timer
    let tc = tRem <= 30 ? '#FF4444' : (tRem <= 60 ? '#FFD700' : '#00FF00');
    cx.fillStyle = tc; cx.font = 'bold 18px Bangers';
    cx.fillText('‚è±Ô∏è ' + fmT(tRem), 10, 25);
    // Score
    cx.fillStyle = '#FFD700'; cx.fillText('üèÜ ' + sc, 10, 48);
    // Lives
    cx.fillStyle = '#FF4444'; cx.font = 'bold 14px Arial';
    cx.fillText('‚ù§Ô∏è'.repeat(Math.max(0, Math.min(vid, 10))), 10, 68);
    // Progress bar
    let bX=10, bY=78, bW=110, bH=10;
    cx.fillStyle='#333'; cx.fillRect(bX,bY,bW,bH);
    cx.fillStyle='#75AADB'; cx.fillRect(bX,bY,bW*prog,bH);
    cx.strokeStyle='#fff'; cx.lineWidth=1; cx.strokeRect(bX,bY,bW,bH);
    cx.fillStyle='#fff'; cx.font='bold 9px Arial';
    cx.fillText('üèõÔ∏è Casa Rosada '+~~(prog*100)+'%', bX, bY+22);
    // Shield
    let sX=10, sY=105, sW=70, sH=8;
    cx.fillStyle='#333'; cx.fillRect(sX,sY,sW,sH);
    cx.fillStyle=P.sa?'#FFD700':'#75AADB'; cx.fillRect(sX,sY,sW*(P.se/100),sH);
    cx.strokeStyle='#fff'; cx.strokeRect(sX,sY,sW,sH);
    cx.fillText('üõ°Ô∏è', sX, sY+20);
    // Right side
    cx.textAlign='right';
    cx.fillStyle='#aaa'; cx.font='bold 12px Bangers';
    cx.fillText('R√©cord: '+hiSc, cv.width-10, 25);
    cx.fillStyle='#FF6347';
    cx.fillText('Oleada '+wav, cv.width-10, 45);
}

// =============================================
// GAME LOOP
// =============================================
function loop() {
    if (!gRun) return;
    update(); draw();
    requestAnimationFrame(loop);
}

// =============================================
// CONTROLS - KEYBOARD
// =============================================
addEventListener('keydown', e => {
    if (!gRun) return;
    if (e.key==='ArrowLeft'||e.key==='a') mL=true;
    if (e.key==='ArrowRight'||e.key==='d') mR=true;
    if (e.key===' '||e.key==='ArrowUp'||e.key==='w') { e.preventDefault(); jump(); }
    if ((e.key==='s'||e.key==='Shift') && !skH) { skH=true; if(P.se>10)P.sa=true; }
    if (e.key==='x') shootUp();
    if (e.key==='z') shootSide(P.fr?1:-1);
    if (e.key==='q') shootSide(-1);
    if (e.key==='e') shootSide(1);
});
addEventListener('keyup', e => {
    if (e.key==='ArrowLeft'||e.key==='a') mL=false;
    if (e.key==='ArrowRight'||e.key==='d') mR=false;
    if (e.key==='s'||e.key==='Shift') { skH=false; P.sa=false; }
});

// Click to shoot
cv.addEventListener('click', e => {
    if (!gRun) return;
    const r = cv.getBoundingClientRect();
    let mx = e.clientX - r.left + cam.x;
    let my = e.clientY - r.top + cam.y;
    shootDir(mx - (P.x+P.w/2), my - (P.y+P.h/2));
});

// =============================================
// CONTROLS - MOBILE
// =============================================
function addT(id, onS, onE) {
    let el = $(id); if(!el)return;
    el.addEventListener('touchstart', e=>{e.preventDefault();onS();},{passive:false});
    if(onE) el.addEventListener('touchend', e=>{e.preventDefault();onE();},{passive:false});
}
addT('bL',()=>{mL=true},()=>{mL=false});
addT('bR',()=>{mR=true},()=>{mR=false});
addT('bJ',()=>{if(gRun)jump()});
addT('bSh',()=>{if(gRun&&P.se>10)P.sa=true},()=>{P.sa=false});
addT('bSL',()=>{if(gRun)shootSide(-1)});
addT('bSU',()=>{if(gRun)shootUp()});
addT('bSR',()=>{if(gRun)shootSide(1)});

cv.addEventListener('touchstart', e=>{
    if(!gRun)return; e.preventDefault();
    const r=cv.getBoundingClientRect(), t=e.touches[0];
    let mx=t.clientX-r.left+cam.x, my=t.clientY-r.top+cam.y;
    if(t.clientY-r.top < cv.height*0.6) shootDir(mx-(P.x+P.w/2), my-(P.y+P.h/2));
},{passive:false});

</script>
</body>
</html>
